name: Coverage Check

on:
  pull_request:
    branches: ["**"]
    paths:
      - 'backend/**'
      - 'CodeCoverage.runsettings'
      - '.github/workflows/coverage-check.yml'
  push:
    branches: ["main", "develop"]
    paths:
      - 'backend/**'
      - 'CodeCoverage.runsettings'
      - '.github/workflows/coverage-check.yml'

jobs:
  coverage-analysis:
    name: Coverage Analysis
    runs-on: ubuntu-latest
    needs: []  # This will run after backend tests when they're in the same workflow run
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '9.0.x'
      
      - name: Install bc for calculations
        run: sudo apt-get update && sudo apt-get install -y bc
      
      # Run all tests to generate coverage data
      - name: Run User Service Tests with Coverage
        run: |
          dotnet restore backend-user.tests/backend-user.tests.csproj
          dotnet build backend-user.tests/backend-user.tests.csproj --no-restore
          dotnet test backend-user.tests/backend-user.tests.csproj --no-build --verbosity normal \
            --collect:"XPlat Code Coverage" \
            --results-directory:"./TestResults/User" \
            --settings:"../CodeCoverage.runsettings"
        working-directory: ./backend
      
      - name: Run Messages Service Tests with Coverage
        run: |
          dotnet restore backend-messages.tests/backend-messages.tests.csproj
          dotnet build backend-messages.tests/backend-messages.tests.csproj --no-restore
          dotnet test backend-messages.tests/backend-messages.tests.csproj --no-build --verbosity normal \
            --collect:"XPlat Code Coverage" \
            --results-directory:"./TestResults/Messages" \
            --settings:"../CodeCoverage.runsettings"
        working-directory: ./backend
      
      - name: Run Portfolio Service Tests with Coverage
        run: |
          dotnet restore backend-portfolio.tests/backend-portfolio.tests.csproj
          dotnet build backend-portfolio.tests/backend-portfolio.tests.csproj --no-restore
          dotnet test backend-portfolio.tests/backend-portfolio.tests.csproj --no-build --verbosity normal \
            --collect:"XPlat Code Coverage" \
            --results-directory:"./TestResults/Portfolio" \
            --settings:"../CodeCoverage.runsettings"
        working-directory: ./backend
      
      - name: Run AI Service Tests with Coverage
        run: |
          dotnet restore backend-AI.tests/backend-AI.tests.csproj
          dotnet build backend-AI.tests/backend-AI.tests.csproj --no-restore
          dotnet test backend-AI.tests/backend-AI.tests.csproj --no-build --verbosity normal \
            --collect:"XPlat Code Coverage" \
            --results-directory:"./TestResults/AI" \
            --settings:"../CodeCoverage.runsettings"
        working-directory: ./backend
      
      - name: Install ReportGenerator
        run: |
          dotnet tool install -g dotnet-reportgenerator-globaltool
          echo "$HOME/.dotnet/tools" >> $GITHUB_PATH
      
      - name: Generate Coverage Reports and Check Thresholds
        run: |
          # Create coverage reports directory
          mkdir -p ./coverage-reports
          
          # Generate User Service coverage report
          echo "ðŸ“Š Generating User Service coverage report..."
          reportgenerator -reports:"./backend/TestResults/User/**/coverage.cobertura.xml" \
            -targetdir:"./coverage-reports/user" \
            -reporttypes:"Cobertura;HtmlInline_AzurePipelines"
          
          # Generate Messages Service coverage report
          echo "ðŸ“Š Generating Messages Service coverage report..."
          reportgenerator -reports:"./backend/TestResults/Messages/**/coverage.cobertura.xml" \
            -targetdir:"./coverage-reports/messages" \
            -reporttypes:"Cobertura;HtmlInline_AzurePipelines"
          
          # Generate Portfolio Service coverage report
          echo "ðŸ“Š Generating Portfolio Service coverage report..."
          reportgenerator -reports:"./backend/TestResults/Portfolio/**/coverage.cobertura.xml" \
            -targetdir:"./coverage-reports/portfolio" \
            -reporttypes:"Cobertura;HtmlInline_AzurePipelines"
          
          # Generate AI Service coverage report
          echo "ðŸ“Š Generating AI Service coverage report..."
          reportgenerator -reports:"./backend/TestResults/AI/**/coverage.cobertura.xml" \
            -targetdir:"./coverage-reports/ai" \
            -reporttypes:"Cobertura;HtmlInline_AzurePipelines"
          
          # Function to check coverage
          check_coverage() {
            local service_name=$1
            local coverage_file=$2
            local min_threshold=85
            
            if [ ! -f "$coverage_file" ]; then
              echo "âŒ Coverage file not found for $service_name: $coverage_file"
              exit 1
            fi
            
            # Extract line coverage rate
            local coverage_rate=$(grep -o 'line-rate="[^"]*"' "$coverage_file" | head -1 | sed 's/line-rate="//' | sed 's/"//')
            
            if [ -z "$coverage_rate" ]; then
              echo "âŒ Could not extract coverage rate from $service_name coverage file"
              exit 1
            fi
            
            # Convert to percentage (multiply by 100 and round)
            local coverage_percent=$(echo "scale=1; $coverage_rate * 100" | bc -l | cut -d. -f1)
            
            echo "ðŸ“ˆ $service_name Coverage: ${coverage_percent}%"
            
            if [ "$coverage_percent" -lt $min_threshold ]; then
              echo "âŒ $service_name coverage (${coverage_percent}%) is below the required ${min_threshold}% threshold"
              return 1
            else
              echo "âœ… $service_name coverage (${coverage_percent}%) meets the ${min_threshold}% threshold"
              return 0
            fi
          }
          
          # Check coverage for each service
          exit_code=0
          
          echo "ðŸ” Checking User Service coverage..."
          check_coverage "User Service" "./coverage-reports/user/Cobertura.xml" || exit_code=1
          
          echo "ðŸ” Checking Messages Service coverage..."
          check_coverage "Messages Service" "./coverage-reports/messages/Cobertura.xml" || exit_code=1
          
          echo "ðŸ” Checking Portfolio Service coverage..."
          check_coverage "Portfolio Service" "./coverage-reports/portfolio/Cobertura.xml" || exit_code=1
          
          echo "ðŸ” Checking AI Service coverage..."
          check_coverage "AI Service" "./coverage-reports/ai/Cobertura.xml" || exit_code=1
          
          if [ $exit_code -eq 1 ]; then
            echo ""
            echo "ðŸ’¥ Build failed due to insufficient code coverage!"
            echo "Please add more tests to meet the 85% coverage requirement."
            exit 1
          else
            echo ""
            echo "ðŸŽ‰ All services meet the code coverage requirements!"
          fi
      
      - name: Upload Coverage Reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: coverage-reports
          path: coverage-reports/
      
      - name: Generate Coverage Summary
        if: always()
        run: |
          echo "## ðŸ“Š Coverage Report Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Service | Coverage | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|---------|----------|--------|" >> $GITHUB_STEP_SUMMARY
          
          # Function to get coverage and status
          get_coverage_info() {
            local service_name=$1
            local coverage_file=$2
            
            if [ -f "$coverage_file" ]; then
              local coverage_rate=$(grep -o 'line-rate="[^"]*"' "$coverage_file" | head -1 | sed 's/line-rate="//' | sed 's/"//')
              if [ -n "$coverage_rate" ]; then
                local coverage_percent=$(echo "scale=1; $coverage_rate * 100" | bc -l | cut -d. -f1)
                if [ "$coverage_percent" -ge 85 ]; then
                  echo "| $service_name | ${coverage_percent}% | âœ… Pass |" >> $GITHUB_STEP_SUMMARY
                else
                  echo "| $service_name | ${coverage_percent}% | âŒ Fail |" >> $GITHUB_STEP_SUMMARY
                fi
              else
                echo "| $service_name | N/A | âŒ Error |" >> $GITHUB_STEP_SUMMARY
              fi
            else
              echo "| $service_name | N/A | âŒ Missing |" >> $GITHUB_STEP_SUMMARY
            fi
          }
          
          get_coverage_info "User Service" "./coverage-reports/user/Cobertura.xml"
          get_coverage_info "Messages Service" "./coverage-reports/messages/Cobertura.xml"
          get_coverage_info "Portfolio Service" "./coverage-reports/portfolio/Cobertura.xml"
          get_coverage_info "AI Service" "./coverage-reports/ai/Cobertura.xml"
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Minimum Required Coverage:** 85%" >> $GITHUB_STEP_SUMMARY
